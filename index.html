<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Wedabime Pramukayo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #002200; --text-neon: #39FF14; --card-bg: #003300; }
        body { background-color: var(--bg-dark); color: var(--text-neon); font-family: 'Courier New', monospace; }
        .tech-card { background-color: var(--card-bg); border-radius: 15px; border: 1px solid #004400; padding: 20px; }
        .nav-btn { border-bottom: 2px solid transparent; transition: 0.3s; padding: 5px 10px; cursor: pointer; color: #558855; }
        .nav-btn.active { border-color: #39FF14; color: white; }
        input { background-color: #001100; border: 1px solid #39FF14; color: white; padding: 10px; border-radius: 5px; outline: none; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-quotationissued { background: orange; color: black; }
        .status-pending { background: yellow; color: black; }
        .status-completed { background: green; color: white; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div id="loginSection" class="flex items-center justify-center min-h-[80vh] w-full max-w-sm">
        <div class="tech-card w-full text-center">
            <h1 class="text-2xl font-bold mb-4 text-white">SYSTEM ACCESS</h1>
            <input type="password" id="passwordInput" class="w-full text-center mb-4" placeholder="Access Code">
            <button onclick="checkLogin()" class="w-full bg-[#39FF14] text-black font-bold py-2 rounded hover:shadow-[0_0_15px_#39FF14]">LOGIN</button>
            <p id="loginError" class="text-red-500 mt-2 hidden">Access Denied!</p>
        </div>
    </div>

    <div id="appSection" class="hidden w-full max-w-6xl">
        
        <div class="flex gap-6 mb-8 border-b border-[#004400] pb-2 text-sm font-bold uppercase tracking-widest">
            <span id="navReg" class="nav-btn active" onclick="showTab('registration')">Registration</span>
            <span id="navView" class="nav-btn" onclick="showTab('viewCustomers')">View Customers</span>
        </div>

        <div id="registrationTab" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="tech-card">
                <h2 class="text-white font-bold mb-4 uppercase border-l-4 border-[#39FF14] pl-2">New Customer</h2>
                <div class="flex flex-col gap-3">
                    <input id="name" type="text" placeholder="Customer Name">
                    <input id="address" type="text" placeholder="Address">
                    <input id="phone" type="text" placeholder="Phone Number">
                    
                    <div class="bg-[#002200] p-3 rounded text-sm space-y-3">
                        <div>
                            <p class="text-gray-400 mb-1">Gutter:</p>
                            <div class="flex gap-4">
                                <label><input type="checkbox" class="service-check" data-category="Gutter" value="Remove"> Rem</label>
                                <label><input type="checkbox" class="service-check" data-category="Gutter" value="New"> New</label>
                                <label><input type="checkbox" class="service-check" data-category="Gutter" value="Repair"> Rep</label>
                            </div>
                        </div>
                        <div>
                            <p class="text-gray-400 mb-1">Ceiling:</p>
                            <div class="flex gap-4">
                                <label><input type="checkbox" class="service-check" data-category="Ceiling" value="Remove"> Rem</label>
                                <label><input type="checkbox" class="service-check" data-category="Ceiling" value="New"> New</label>
                                <label><input type="checkbox" class="service-check" data-category="Ceiling" value="Repair"> Rep</label>
                            </div>
                        </div>
                    </div>

                    <input id="totalValue" type="number" placeholder="Total Project Value (LKR)" class="text-right font-bold text-xl text-[#39FF14]">
                    <button id="submitBtn" onclick="submitCustomer()" class="bg-[#39FF14] text-black font-bold py-3 mt-2 rounded">REGISTER</button>
                </div>
            </div>
            
            <div class="tech-card flex flex-col items-center">
                <h2 class="text-white font-bold mb-4 self-start uppercase border-l-4 border-yellow-500 pl-2">Project Stats</h2>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div id="viewCustomersTab" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white font-bold uppercase border-l-4 border-blue-500 pl-2">Customer Directory</h2>
                <button onclick="fetchAllCustomers()" class="text-[10px] border border-[#39FF14] px-3 py-1 rounded">REFRESH ↻</button>
            </div>
            <input type="text" id="searchInput" onkeyup="searchCustomers()" placeholder="Search by name or ID..." class="w-full mb-6">
            <div id="customerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyfbzzVvKH0vW7d9cPHG3mBBqWF7n3tx4-WmIy4ivhRalVGNWueU2Jg9oc40mPacYb/exec"; // ⚠️ අමතක නොකර මෙය ඇතුළත් කරන්න
        let allCustomers = [];
        let myChart = null;

        // --- NAVIGATION & LOGIN ---
        function checkLogin() {
            const pass = document.getElementById("passwordInput").value;
            if (pass === "admin123") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                updateDashboard();
            } else {
                document.getElementById("loginError").classList.remove("hidden");
            }
        }

        function showTab(tabName) {
            document.getElementById('registrationTab').classList.toggle('hidden', tabName !== 'registration');
            document.getElementById('viewCustomersTab').classList.toggle('hidden', tabName !== 'viewCustomers');
            document.getElementById('navReg').classList.toggle('active', tabName === 'registration');
            document.getElementById('navView').classList.toggle('active', tabName === 'viewCustomers');
            if(tabName === 'viewCustomers') fetchAllCustomers();
        }

        // --- HELPERS ---
        function getServiceStatus(category) {
            const checks = document.querySelectorAll(`.service-check[data-category="${category}"]:checked`);
            return checks.length > 0 ? Array.from(checks).map(c => c.value).join(", ") : "None";
        }

        // --- DATA ACTIONS ---
        async function submitCustomer() {
            const btn = document.getElementById("submitBtn");
            const payload = {
                action: "create",
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                phone: document.getElementById("phone").value,
                gutter: getServiceStatus("Gutter"),
                ceiling: getServiceStatus("Ceiling"),
                roof: "None",
                totalValue: document.getElementById("totalValue").value
            };

            if(!payload.name || !payload.phone) return alert("Fill Name and Phone!");
            btn.disabled = true; btn.innerText = "SAVING...";

            try {
                await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
                alert("✅ Registered!");
                location.reload();
            } catch (e) { alert("Error!"); btn.disabled = false; }
        }

        async function fetchAllCustomers() {
            const grid = document.getElementById("customerGrid");
            grid.innerHTML = "<p>Scanning Matrix...</p>";
            try {
                const response = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({action:"getAll"}) });
                allCustomers = await response.json();
                renderCards(allCustomers);
            } catch (e) { grid.innerHTML = "Error loading data."; }
        }

        function renderCards(data) {
            const grid = document.getElementById("customerGrid");
            grid.innerHTML = data.map(c => `
                <div class="tech-card border-l-2 border-[#39FF14] text-sm">
                    <div class="flex justify-between mb-2">
                        <span class="text-[9px] text-gray-500 uppercase">${c.id}</span>
                        <span class="status-badge status-${c.status.toLowerCase().replace(' ', '')}">${c.status}</span>
                    </div>
                    <h3 class="text-white font-bold">${c.name}</h3>
                    <p class="text-[10px] text-gray-400 mb-2">${c.address}</p>
                    <div class="border-t border-[#004400] pt-2 text-[10px] space-y-1">
                        <p><span class="text-[#39FF14]">SERVICES:</span> ${c.services}</p>
                        <p class="font-bold text-white">PAID: ${c.paid} / ${c.total}</p>
                    </div>
                </div>
            `).join('');
        }

        function searchCustomers() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            renderCards(allCustomers.filter(c => c.name.toLowerCase().includes(term) || c.id.toLowerCase().includes(term)));
        }

        async function updateDashboard() {
            try {
                const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({action: "getStats"}) });
                const stats = await res.json();
                const ctx = document.getElementById('statusChart').getContext('2d');
                if(myChart) myChart.destroy();
                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats),
                        datasets: [{ data: Object.values(stats), backgroundColor: ['#FFA500', '#FFFF00', '#008000'], borderColor: '#002200' }]
                    },
                    options: { plugins: { legend: { labels: { color: 'white', font: { family: 'monospace' } } } } }
                });
            } catch (e) { console.log(e); }
        }
    </script>
</body>
</html>