<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECH MASTER CRM - Wedabime Pramukayo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #001a00; --text-neon: #39FF14; --card-bg: #002200; }
        body { background-color: var(--bg-dark); color: var(--text-neon); font-family: 'Courier New', monospace; }
        .tech-card { background-color: var(--card-bg); border-radius: 12px; border: 1px solid #004400; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .nav-btn { border-bottom: 2px solid transparent; transition: 0.3s; padding: 5px 15px; cursor: pointer; color: #006600; font-weight: bold; }
        .nav-btn.active { border-color: #39FF14; color: #39FF14; }
        input { background-color: #000b00; border: 1px solid #004400; color: white; padding: 10px; border-radius: 5px; outline: none; width: 100%; }
        input:focus { border-color: #39FF14; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-quotationissued { background: #ff9900; color: black; }
        .status-pending { background: #ffff00; color: black; }
        .status-completed { background: #00cc00; color: white; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="loginSection" class="flex items-center justify-center min-h-[80vh]">
        <div class="tech-card w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold mb-6">SYSTEM ACCESS</h1>
            <input type="password" id="passwordInput" class="text-center mb-4" placeholder="ENTER PASSWORD">
            <button onclick="checkLogin()" class="w-full bg-[#39FF14] text-black font-bold py-2 rounded hover:brightness-110">LOGIN</button>
            <p id="loginError" class="text-red-500 mt-2 hidden text-xs">Access Denied!</p>
        </div>
    </div>

    <div id="appSection" class="hidden max-w-6xl mx-auto">
        
        <div class="flex gap-4 mb-8 border-b border-[#003300] pb-2 uppercase text-xs tracking-tighter overflow-x-auto">
            <span id="navReg" class="nav-btn active" onclick="showTab('registration')">Registration</span>
            <span id="navView" class="nav-btn" onclick="showTab('viewCustomers')">View Customers</span>
            <span id="navPay" class="nav-btn" onclick="showTab('payment')">Payments</span>
        </div>

        <div id="registrationTab" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="tech-card">
                <h2 class="text-white font-bold mb-4 border-l-4 border-[#39FF14] pl-2 uppercase">New Customer</h2>
                <div class="space-y-3">
                    <input id="name" type="text" placeholder="Customer Name">
                    <input id="address" type="text" placeholder="Address">
                    <input id="phone" type="text" placeholder="Phone Number">
                    
                    <div class="grid grid-cols-1 gap-4 bg-[#001100] p-4 rounded border border-[#003300] text-[11px]">
                        <div>
                            <p class="mb-2 text-[#39FF14]">Gutter:</p>
                            <div class="flex gap-4"><label><input type="checkbox" class="service-check" data-cat="Gutter" value="Removing"> Removing</label> <label><input type="checkbox" class="service-check" data-cat="Gutter" value="New"> New</label> <label><input type="checkbox" class="service-check" data-cat="Gutter" value="Repair"> Repair</label></div>
                        </div>
                        <div>
                            <p class="mb-2 text-[#39FF14]">Ceiling:</p>
                            <div class="flex gap-4"><label><input type="checkbox" class="service-check" data-cat="Ceiling" value="Removing"> Removing</label> <label><input type="checkbox" class="service-check" data-cat="Ceiling" value="New"> New</label> <label><input type="checkbox" class="service-check" data-cat="Ceiling" value="Repair"> Repair</label></div>
                        </div>
                        <div>
                            <p class="mb-2 text-[#39FF14]">Roof:</p>
                            <div class="flex gap-4"><label><input type="checkbox" class="service-check" data-cat="Roof" value="Removing"> Removing</label> <label><input type="checkbox" class="service-check" data-cat="Roof" value="New"> New</label> <label><input type="checkbox" class="service-check" data-cat="Roof" value="Repair"> Repair</label></div>
                        </div>
                    </div>

                    <input id="totalValue" type="number" placeholder="Total Project Value (LKR)">
                    <button id="submitBtn" onclick="submitCustomer()" class="w-full bg-[#39FF14] text-black font-bold py-3 rounded">REGISTER & ISSUE QUOTE</button>
                </div>
            </div>
            <div class="tech-card flex flex-col items-center justify-center">
                <h2 class="text-white font-bold mb-4 self-start">PROJECT STATS</h2>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div id="viewCustomersTab" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white font-bold uppercase">Customer Records</h2>
                <input type="text" id="searchInput" onkeyup="searchCustomers()" placeholder="Search Name or ID..." class="max-w-xs text-sm">
            </div>
            <div id="customerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="paymentTab" class="hidden">
            <div class="tech-card max-w-md mx-auto">
                <h2 class="text-white font-bold mb-4 border-l-4 border-yellow-500 pl-2 uppercase">Add Payment</h2>
                <div class="space-y-4">
                    <input id="payId" type="text" placeholder="Customer ID (e.g. CUST-1)">
                    <input id="payAmount" type="number" placeholder="Payment Amount (LKR)">
                    <button id="payBtn" onclick="updatePayment()" class="w-full bg-yellow-500 text-black font-bold py-3 rounded">ADD PAYMENT</button>
                </div>
            </div>
        </div>

    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="tech-card w-full max-w-md border-2 border-yellow-500">
            <h2 class="text-yellow-500 font-bold mb-4 uppercase">Edit Customer Details</h2>
            <div class="space-y-3">
                <p class="text-[10px] text-gray-500">ID: <span id="editIdLabel"></span></p>
                <input id="editId" type="hidden">
                <input id="editName" type="text" placeholder="Name">
                <input id="editAddress" type="text" placeholder="Address">
                <input id="editPhone" type="text" placeholder="Phone">
                <input id="editTotal" type="number" placeholder="Total Value">
                <div class="flex gap-2 pt-2">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-800 text-white py-2 rounded text-sm">CANCEL</button>
                    <button id="saveEditBtn" onclick="saveEdit()" class="flex-1 bg-yellow-500 text-black font-bold py-2 rounded text-sm">SAVE CHANGES</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyfbzzVvKH0vW7d9cPHG3mBBqWF7n3tx4-WmIy4ivhRalVGNWueU2Jg9oc40mPacYb/exec";
        let allCustomers = [];
        let myChart = null;

        // AUTH & TABS
        function checkLogin() {
            if (document.getElementById("passwordInput").value === "admin123") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                updateDashboard();
            } else {
                document.getElementById("loginError").classList.remove("hidden");
            }
        }

        function showTab(tabName) {
            const tabs = ['registrationTab', 'viewCustomersTab', 'paymentTab'];
            const navs = ['navReg', 'navView', 'navPay'];
            tabs.forEach(t => document.getElementById(t).classList.add('hidden'));
            navs.forEach(n => document.getElementById(n).classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            const navId = tabName === 'registration' ? 'navReg' : (tabName === 'viewCustomers' ? 'navView' : 'navPay');
            document.getElementById(navId).classList.add('active');
            
            if(tabName === 'viewCustomers') fetchAllCustomers();
        }

        // ACTIONS
        async function submitCustomer() {
            const btn = document.getElementById("submitBtn");
            const services = Array.from(document.querySelectorAll('.service-check:checked')).map(cb => cb.value).join(", ");
            const payload = {
                action: "create",
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                phone: document.getElementById("phone").value,
                gutter: getServiceStatus("Gutter"),
                ceiling: getServiceStatus("Ceiling"),
                roof: getServiceStatus("Roof"),
                totalValue: document.getElementById("totalValue").value
            };

            if(!payload.name) return alert("Name is required!");
            btn.disabled = true; btn.innerText = "SAVING...";

            await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("✅ Registered Successfully!");
            
            document.querySelectorAll('#registrationTab input').forEach(i => i.value = "");
            document.querySelectorAll('.service-check').forEach(c => c.checked = false);
            btn.disabled = false; btn.innerText = "REGISTER & ISSUE QUOTE";
            updateDashboard();
        }

        function getServiceStatus(cat) {
            const chk = Array.from(document.querySelectorAll(`.service-check[data-cat="${cat}"]:checked`));
            return chk.length > 0 ? chk.map(c => c.value).join(", ") : "None";
        }

        async function updatePayment() {
            const btn = document.getElementById("payBtn");
            const payload = {
                action: "update",
                customerId: document.getElementById("payId").value,
                payment: document.getElementById("payAmount").value
            };
            if(!payload.customerId || !payload.payment) return alert("Fill all fields!");

            btn.disabled = true;
            const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
            const data = await res.json();
            alert(data.result === "success" ? "✅ Payment Added!" : "❌ ID Not Found!");
            
            document.getElementById("payId").value = "";
            document.getElementById("payAmount").value = "";
            btn.disabled = false;
            updateDashboard();
        }

        // VIEW & EDIT
        async function fetchAllCustomers() {
            const grid = document.getElementById("customerGrid");
            grid.innerHTML = "<p class='text-xs'>Scanning Matrix...</p>";
            const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({action:"getAll"}) });
            allCustomers = await res.json();
            renderCards(allCustomers);
        }

        function renderCards(data) {
            const grid = document.getElementById("customerGrid");
            grid.innerHTML = data.map(c => `
                <div class="tech-card border-l-4 border-[#39FF14]">
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] text-gray-500">${c.id}</span>
                        <button onclick="openEditModal('${c.id}', '${c.name}', '${c.address}', '${c.phone}', '${c.total}')" class="text-[10px] text-yellow-500 border border-yellow-500 px-2 rounded font-bold">EDIT</button>
                    </div>
                    <h3 class="text-white font-bold text-sm">${c.name}</h3>
                    <p class="text-[10px] text-gray-400 mb-3">${c.address}</p>
                    <div class="text-[10px] space-y-1 pt-2 border-t border-[#003300]">
                        <p><span class="text-gray-500 uppercase">Services:</span> ${c.services}</p>
                        <p class="text-white font-bold">PAID: RS.${c.paid} / ${c.total}</p>
                        <span class="status-badge status-${c.status.toLowerCase().replace(/\s/g, '')} inline-block mt-1">${c.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function openEditModal(id, name, address, phone, total) {
            document.getElementById("editId").value = id;
            document.getElementById("editIdLabel").innerText = id;
            document.getElementById("editName").value = name;
            document.getElementById("editAddress").value = address;
            document.getElementById("editPhone").value = phone;
            document.getElementById("editTotal").value = total;
            document.getElementById("editModal").classList.remove("hidden");
        }

        function closeEditModal() { document.getElementById("editModal").classList.add("hidden"); }

        async function saveEdit() {
            const btn = document.getElementById("saveEditBtn");
            const payload = {
                action: "edit",
                customerId: document.getElementById("editId").value,
                name: document.getElementById("editName").value,
                address: document.getElementById("editAddress").value,
                phone: document.getElementById("editPhone").value,
                totalValue: document.getElementById("editTotal").value
            };
            btn.disabled = true;
            await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("✅ Updated!");
            closeEditModal();
            btn.disabled = false;
            fetchAllCustomers();
        }

        async function updateDashboard() {
            const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({action: "getStats"}) });
            const stats = await res.json();
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats),
                    datasets: [{ data: Object.values(stats), backgroundColor: ['#ff9900', '#ffff00', '#00cc00'], borderColor: '#001a00' }]
                },
                options: { plugins: { legend: { labels: { color: 'white', font: {family: 'monospace'} } } } }
            });
        }

        function searchCustomers() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            renderCards(allCustomers.filter(c => c.name.toLowerCase().includes(term) || c.id.toLowerCase().includes(term)));
        }
    </script>
</body>
</html>