<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Wedabime Pramukayo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #002200;
            --text-neon: #39FF14;
            --text-white: #FFFFFF;
            --card-bg: #003300;
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-neon); 
            font-family: 'Courier New', Courier, monospace; 
        }

        input, select {
            background-color: #001100;
            border: 1px solid var(--text-neon);
            color: var(--text-white);
            outline: none;
            transition: 0.3s;
        }
        input:focus { box-shadow: 0 0 10px var(--text-neon); }

        .tech-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #004400;
        }

        .btn-neon {
            background-color: var(--text-neon);
            color: #000;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-neon:hover {
            background-color: #32CC12;
            box-shadow: 0 0 15px var(--text-neon);
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-white);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="loginSection" class="text-center w-full max-w-md animate-fade-in">
        <div class="tech-card p-8">
            <h1 class="text-3xl font-bold mb-6">SYSTEM ACCESS</h1>
            <input type="password" id="passwordInput" placeholder="Enter Access Code" class="w-full p-3 rounded mb-4 text-center text-xl">
            <button onclick="checkLogin()" class="btn-neon w-full py-3 rounded text-lg">LOGIN</button>
            <p id="loginError" class="text-red-500 mt-2 hidden">Access Denied!</p>
        </div>
    </div>

    <div id="appSection" class="hidden w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fade-in">
        
        <div class="lg:col-span-2 flex justify-between items-center mb-4 border-b border-[#39FF14] pb-2">
            <div>
                <h1 class="text-2xl font-bold text-white">WEDABIME PRAMUKAYO <span class="text-[#39FF14]">CRM</span></h1>
                <p class="text-xs text-gray-400">Construction Management System v1.1</p>
            </div>
            <button onclick="updateDashboard()" class="text-xs border border-[#39FF14] px-3 py-1 rounded hover:bg-[#39FF14] hover:text-black transition">
                REFRESH DATA ‚Üª
            </button>
        </div>

        <div class="tech-card p-6">
            <h2 class="text-xl font-bold text-white mb-4 border-l-4 border-[#39FF14] pl-3">NEW CUSTOMER</h2>
            
            <div class="space-y-3">
                <input id="name" type="text" placeholder="Customer Name" class="w-full p-2 rounded">
                <input id="address" type="text" placeholder="Address" class="w-full p-2 rounded">
                <input id="phone" type="text" placeholder="Phone Number" class="w-full p-2 rounded">
                
                <div class="bg-[#002200] p-3 rounded border border-[#004400] space-y-3">
                    <div>
                        <p class="text-[#39FF14] font-bold text-sm mb-1">üåßÔ∏è Gutter (‡∑Ä‡∑ê‡∑Ñ‡∑í‡∂¥‡∑í‡∑Ñ‡∑í‡∂Ω‡∑í)</p>
                        <div class="flex gap-3 checkbox-group">
                            <label><input type="checkbox" class="service-check" data-category="Gutter" value="Remove"> Remove</label>
                            <label><input type="checkbox" class="service-check" data-category="Gutter" value="New"> New</label>
                            <label><input type="checkbox" class="service-check" data-category="Gutter" value="Repair"> Repair</label>
                        </div>
                    </div>

                    <div>
                        <p class="text-[#39FF14] font-bold text-sm mb-1">üè† Ceiling (‡∑É‡∑í‡∑Ä‡∑í‡∂Ω‡∑í‡∂∏‡∑ä)</p>
                        <div class="flex gap-3 checkbox-group">
                            <label><input type="checkbox" class="service-check" data-category="Ceiling" value="Remove"> Remove</label>
                            <label><input type="checkbox" class="service-check" data-category="Ceiling" value="New"> New</label>
                            <label><input type="checkbox" class="service-check" data-category="Ceiling" value="Repair"> Repair</label>
                        </div>
                    </div>

                    <div>
                        <p class="text-[#39FF14] font-bold text-sm mb-1">üèóÔ∏è Roof (‡∑Ä‡∑Ñ‡∂Ω)</p>
                        <div class="flex gap-3 checkbox-group">
                            <label><input type="checkbox" class="service-check" data-category="Roof" value="Remove"> Remove</label>
                            <label><input type="checkbox" class="service-check" data-category="Roof" value="New"> New</label>
                            <label><input type="checkbox" class="service-check" data-category="Roof" value="Repair"> Repair</label>
                        </div>
                    </div>
                </div>

                <input id="totalValue" type="number" placeholder="Total Project Value (LKR)" class="w-full p-2 rounded text-right font-bold text-xl">
                
                <button onclick="submitCustomer()" id="submitBtn" class="btn-neon w-full py-3 rounded mt-2">
                    REGISTER & ISSUE QUOTE
                </button>
            </div>
        </div>

        <div class="space-y-8">
            <div class="tech-card p-6">
                <h2 class="text-xl font-bold text-white mb-4 border-l-4 border-yellow-400 pl-3">UPDATE PAYMENT</h2>
                <div class="flex gap-2">
                    <input id="payId" type="text" placeholder="Customer ID (e.g. CUST-1)" class="w-1/2 p-2 rounded">
                    <input id="payAmount" type="number" placeholder="Amount (LKR)" class="w-1/2 p-2 rounded">
                    <button onclick="updatePayment()" id="payBtn" class="bg-yellow-400 text-black font-bold px-4 rounded hover:bg-yellow-500">PAY</button>
                </div>
            </div>

            <div class="tech-card p-6">
                <h2 class="text-xl font-bold text-white mb-4 border-l-4 border-blue-500 pl-3">PROJECT STATUS</h2>
                <div class="relative h-64 flex justify-center">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyfbzzVvKH0vW7d9cPHG3mBBqWF7n3tx4-WmIy4ivhRalVGNWueU2Jg9oc40mPacYb/exec";
        let myChart;

        function checkLogin() {
            const pass = document.getElementById("passwordInput").value;
            if (pass === "admin123") {
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("appSection").style.display = "grid"; 
                updateDashboard();
            } else {
                document.getElementById("loginError").style.display = "block";
            }
        }

        function getServiceStatus(category) {
            const checkboxes = document.querySelectorAll(`.service-check[data-category="${category}"]:checked`);
            let values = [];
            checkboxes.forEach((cb) => values.push(cb.value));
            return values.length > 0 ? values.join(", ") : "None";
        }

        async function submitCustomer() {
            const btn = document.getElementById("submitBtn");
            const payload = {
                action: "create",
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                phone: document.getElementById("phone").value,
                gutter: getServiceStatus("Gutter"), // ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂¥‡∑ô‡∑Ö ‡∂∫‡∑Ä‡∂∫‡∑í
                ceiling: getServiceStatus("Ceiling"),
                roof: getServiceStatus("Roof"),
                totalValue: document.getElementById("totalValue").value
            };

            if(!payload.name || !payload.phone) return alert("Required fields missing!");
            btn.disabled = true; btn.innerText = "SAVING...";

            try {
                await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
                alert("‚úÖ Customer Registered with specific services!");
                location.reload();
            } catch (e) {
                alert("‚ùå Connection Error");
                btn.disabled = false;
            }
        }

        async function updatePayment() {
            const id = document.getElementById("payId").value;
            const amount = document.getElementById("payAmount").value;
            const btn = document.getElementById("payBtn");

            if(!id || !amount) return alert("Fill ID and Amount");
            btn.disabled = true;

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "update", customerId: id, payment: amount })
                });
                const res = await response.json();
                if(res.result === "success") {
                    alert("üí∞ Payment Logged!");
                    updateDashboard();
                } else {
                    alert("ID not found!");
                }
                btn.disabled = false;
            } catch (e) {
                btn.disabled = false;
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "getStats" }) 
                });
                const stats = await response.json();
                const ctx = document.getElementById('statusChart').getContext('2d');
                if (myChart) { myChart.destroy(); }

                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats),
                        datasets: [{
                            data: Object.values(stats),
                            backgroundColor: ["#FFA500", "#FFFF00", "#008000"],
                            borderColor: '#002200',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#FFFFFF' } }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>